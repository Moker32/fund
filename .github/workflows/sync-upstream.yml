name: Sync Upstream

on:
  # 每天早上 8 点自动检查更新
  schedule:
    - cron: '0 8 * * *'
  # 手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.repository == 'Moker32/fund'

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/lanZzV/fund.git
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/master)
          LOCAL_SHA=$(git rev-parse HEAD)
          if [ "$UPSTREAM_SHA" != "$LOCAL_SHA" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Create sync PR if update exists
        if: steps.check.outputs.has_update == 'true'
        run: |
          git merge upstream/master --no-edit

          git checkout -b sync-upstream-$(date +%Y%m%d)

          git add -A
          git commit -m "sync: sync with upstream $(git rev-parse --short upstream/master)"

          git push -u https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:sync-upstream-$(date +%Y%m%d) || echo "No changes to sync"

          # 使用 gh CLI 创建 PR
          if command -v gh &> /dev/null; then
            gh pr create --title "Sync: $(date +%Y-%m-%d)" --body "Automated sync with upstream" --head sync-upstream-$(date +%Y%m%d) || echo "PR might already exist"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
